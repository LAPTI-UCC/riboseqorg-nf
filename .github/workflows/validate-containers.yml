name: Validate Containers

on:
  pull_request:
    paths:
      - 'modules/**'
      - 'docker/**'
      - '.github/workflows/validate-containers.yml'
  push:
    branches:
      - main
    paths:
      - 'modules/**'
      - 'docker/**'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

env:
  SINGULARITY_VERSION: 3.8.7

jobs:

  extract-containers:
    name: Extract Container URLs from Modules
    runs-on: ubuntu-latest
    outputs:
      biocontainers: ${{ steps.extract.outputs.biocontainers }}
      custom-docker: ${{ steps.extract.outputs.custom_docker }}
      custom-singularity: ${{ steps.extract.outputs.custom_singularity }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract container URLs from modules
        id: extract
        run: |
          echo "Extracting BioContainers..."
          biocontainers=$(grep -r "biocontainers/" modules/ | \
            grep -o "biocontainers/[^'\"]*" | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "biocontainers=$biocontainers" >> $GITHUB_OUTPUT

          echo "Extracting custom Docker containers..."
          custom_docker=$(grep -r "ghcr.io/" modules/ | \
            grep -o "ghcr.io/[^'\"]*" | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "custom_docker=$custom_docker" >> $GITHUB_OUTPUT

          echo "Extracting custom Singularity containers..."
          custom_singularity=$(grep -r "github.com.*\.sif" modules/ | \
            grep -o "https://github.com/[^'\"]*\.sif" | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "custom_singularity=$custom_singularity" >> $GITHUB_OUTPUT

  validate-biocontainers:
    name: Validate BioContainers
    needs: extract-containers
    runs-on: ubuntu-latest
    if: needs.extract-containers.outputs.biocontainers != '[]'
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJson(needs.extract-containers.outputs.biocontainers) }}

    steps:
      - name: Pull Docker container
        run: |
          echo "Testing: docker://${{ matrix.container }}"
          docker pull ${{ matrix.container }}

      - name: Test container runs
        run: |
          TOOL=$(echo "${{ matrix.container }}" | cut -d'/' -f2 | cut -d':' -f1)
          echo "Testing tool: $TOOL"

          case $TOOL in
            samtools|bowtie|fastp|fastqc|star|multiqc)
              docker run --rm ${{ matrix.container }} $TOOL --version || \
              docker run --rm ${{ matrix.container }} $TOOL -v || \
              docker run --rm ${{ matrix.container }} $TOOL --help
              ;;
            fastq-dl)
              docker run --rm ${{ matrix.container }} fastq-dl --version
              ;;
            pysam)
              docker run --rm ${{ matrix.container }} python -c "import pysam; print(pysam.__version__)"
              ;;
            ribodetector)
              docker run --rm ${{ matrix.container }} ribodetector --help
              ;;
            ucsc-bedgraphtobigwig)
              docker run --rm ${{ matrix.container }} bedGraphToBigWig 2>&1 | head -5
              ;;
            *)
              docker run --rm ${{ matrix.container }} echo "Container runs successfully"
              ;;
          esac

  validate-biocontainers-singularity:
    name: Validate BioContainers (Singularity)
    needs: extract-containers
    runs-on: ubuntu-latest
    if: needs.extract-containers.outputs.biocontainers != '[]'
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJson(needs.extract-containers.outputs.biocontainers) }}

    steps:
      - name: Install Singularity
        uses: eWaterCycle/setup-singularity@v7
        with:
          singularity-version: ${{ env.SINGULARITY_VERSION }}

      - name: Pull and test Singularity container
        run: |
          singularity pull test-container.sif docker://${{ matrix.container }}

          TOOL=$(echo "${{ matrix.container }}" | cut -d'/' -f2 | cut -d':' -f1)
          echo "Testing $TOOL"

          case $TOOL in
            samtools|bowtie|fastp|fastqc|star|multiqc)
              singularity exec test-container.sif $TOOL --version || \
              singularity exec test-container.sif $TOOL -v || \
              singularity exec test-container.sif $TOOL --help
              ;;
            fastq-dl)
              singularity exec test-container.sif fastq-dl --version
              ;;
            pysam)
              singularity exec test-container.sif python -c "import pysam; print(pysam.__version__)"
              ;;
            ribodetector)
              singularity exec test-container.sif ribodetector --help
              ;;
            ucsc-bedgraphtobigwig)
              singularity exec test-container.sif bedGraphToBigWig 2>&1 | head -5
              ;;
            *)
              singularity exec test-container.sif echo "Container runs successfully"
              ;;
          esac

  validate-custom-docker:
    name: Validate Custom Docker Containers
    needs: extract-containers
    runs-on: ubuntu-latest
    if: needs.extract-containers.outputs.custom-docker != '[]'
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJson(needs.extract-containers.outputs.custom-docker) }}

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker container
        run: |
          docker pull ${{ matrix.container }}

      - name: Test custom container
        run: |
          if [[ "${{ matrix.container }}" == *"getrpf"* ]]; then
            docker run --rm ${{ matrix.container }} getRPF --version
          elif [[ "${{ matrix.container }}" == *"ribometric"* ]]; then
            docker run --rm ${{ matrix.container }} RiboMetric --version
          elif [[ "${{ matrix.container }}" == *"rdp-tools"* ]]; then
            docker run --rm ${{ matrix.container }} RDP-Tools --version || \
            docker run --rm ${{ matrix.container }} python -c "import RDP_Tools"
          fi

  validate-custom-singularity:
    name: Validate Custom Singularity Containers
    needs: extract-containers
    runs-on: ubuntu-latest
    if: needs.extract-containers.outputs.custom-singularity != '[]'
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJson(needs.extract-containers.outputs.custom-singularity) }}

    steps:
      - name: Install Singularity
        uses: eWaterCycle/setup-singularity@v7
        with:
          singularity-version: ${{ env.SINGULARITY_VERSION }}

      - name: Download and test Singularity container
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          wget -q --header="Authorization: token $GITHUB_TOKEN" \
            "${{ matrix.container }}" -O test-container.sif || {
            echo "Warning: Could not download .sif (may not exist yet)"
            exit 0
          }

          FILENAME=$(basename "${{ matrix.container }}")

          if [[ "$FILENAME" == *"getRPF"* ]]; then
            singularity exec test-container.sif getRPF --version
          elif [[ "$FILENAME" == *"RiboMetric"* ]]; then
            singularity exec test-container.sif RiboMetric --version
          elif [[ "$FILENAME" == *"RDP-tools"* ]]; then
            singularity exec test-container.sif RDP-Tools --version || \
            singularity exec test-container.sif python -c "import RDP_Tools"
          fi

  validate-container-definitions:
    name: Validate Container Definitions in Modules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check all modules have container directives
        run: |
          echo "Checking for container directives..."
          MISSING=()

          for module in $(find modules/local -name "main.nf"); do
            if grep -q "^process " "$module"; then
              if ! grep -q "^\s*container\s*\"" "$module"; then
                echo "❌ Missing container directive: $module"
                MISSING+=("$module")
              fi
            fi
          done

          if [ ${#MISSING[@]} -ne 0 ]; then
            printf '%s\n' "${MISSING[@]}"
            exit 1
          fi

          echo "All modules have container directives."

      - name: Validate container URL formats
        run: |
          echo "Validating container URL formats..."
          INVALID=()

          for module in $(find modules/local -name "main.nf"); do
            # Accept only: container "<something>"
            if grep -E '^\s*container\s+"[^"]+"' "$module" > /dev/null; then
              continue
            fi

            # If a container directive exists but doesn't match valid pattern → flag it
            if grep -q "^\s*container\s" "$module"; then
              echo "❌ Malformed container directive: $module"
              INVALID+=("$module")
            fi
          done

          if [ ${#INVALID[@]} -ne 0 ]; then
            printf '%s\n' "${INVALID[@]}"
            exit 1
          fi

          echo "All container URL formats are valid!"

  summary:
    name: Validation Summary
    needs: [
      validate-biocontainers,
      validate-biocontainers-singularity,
      validate-custom-docker,
      validate-custom-singularity,
      validate-container-definitions
    ]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Report results
        run: |
          echo "## Container Validation Summary" >> $GITHUB_STEP_SUMMARY

          declare -A JOBS=(
            ["BioContainers (Docker)"]="${{ needs.validate-biocontainers.result }}"
            ["BioContainers (Singularity)"]="${{ needs.validate-biocontainers-singularity.result }}"
            ["Custom Docker"]="${{ needs.validate-custom-docker.result }}"
            ["Custom Singularity"]="${{ needs.validate-custom-singularity.result }}"
            ["Container Definitions"]="${{ needs.validate-container-definitions.result }}"
          )

          for label in "${!JOBS[@]}"; do
            result=${JOBS[$label]}
            if [ "$result" == "success" ]; then
              echo "✅ $label: PASSED" >> $GITHUB_STEP_SUMMARY
            elif [ "$result" == "skipped" ]; then
              echo "⏭️ $label: SKIPPED" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ $label: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "See job logs for details." >> $GITHUB_STEP_SUMMARY
